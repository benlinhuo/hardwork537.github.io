---
layout:     post
title:      浅析tsf
category: php
tags: [php]
description: TSF，全称Tencent Server Framework，底层基于swoole 扩展+ Coroutine实现的PHP协程框架
---

## 简介

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"作为世界上最好的开发语言"，php其高效的开发效率一直被人津津乐道，就像孪生兄弟一样总是如影随形，它的性能问题也一直被人诟病。平时开发过程中，一言不合就直接var_dump然后exit()，调试起来极其方便；还记得上份工作，web侧是用php开发、后台api用的是java，基本每次发布，都是等后台api发布，一个小时候，问他们怎么样了，“已经编译好了一半”，等api OK了，web侧一分钟就上线完成；也正因为如何，不需要每次都进行编译后执行，所以其性能问题也没有C、java等表现优异。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;问题的出现也是进步最大的动力，于是乎php的优化、各种扩展的出现就是推动下的产物。最近表现比较优异的一个就是[swoole](http://www.swoole.com)：PHP的异步、并行、高性能网络通信引擎，使用纯C语言编写；其号称 简单易用开发效率高、并发百万TCP连接……

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;说了这么多，要说的重点终于要登场了，那就是[tsf](https://github.com/tencent-php/tsf)，全称“Tencent Server Framework”；网络层用的是上面提及的swoole，并结合php的协程，实现php的异步、高并发性能。

## DEMO 

* Swoole进程模型

![model](/images/tsf/model.jpg)

* TSF运行架构图

![framework](/images/tsf/framework.bmp)

* TSF协程

![coroutine](/images/tsf/coroutine.bmp)

* 支持start，stop，reload，restart，shutdown, status

![server](/images/tsf/server.png)

* 性能解密

![perform](/images/tsf/perform.png)


## TSF的优势

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;传统的php一般在有数据交互、网络请求的时候(比如db读取、调用后台接口)时都是串行处理的；比如当整个执行过程中有3次接口调用时，总是按顺序执行的：先发送第一次接口调用请求，此时cpu处于等待接口响应状态，等到接口返回数据时，再进行第二次接口调用、然后第三次；可以看出，这种方式下，每次进行网络请求，cpu总会有段时间处于等待状态，不继续往下执行，也不处理其他请求，明显是占着茅坑不拉屎，感觉服务处理请求的效率很低。当接口调用又比较耗时时，整个服务的处理效率更是惨不忍睹。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;就好比说，一个人带着一本书去钓鱼。他的打算是钓到一条鱼(假如钓到一条鱼的等待时间是10分钟)，然后看10分钟书。于是他下好钩，然后就什么也不做，闭目养神等着鱼儿上钩；10分钟后，鱼上钩了，他就暂停钓鱼，接下来看了10分钟的书；然后再钓鱼、看书……两个小时的时间内，他一共钓了6条鱼，看了一个小时的书。此时，你也许禁不住“噗哧”一笑道“这个人是不是傻，他可以边钓鱼边看书”。确实这样！但一般的php执行过程就是这样的！

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;基于这个痛点，tsf进行了很大改善，实现了网络请求的并行处理；比如和上面一样的情况，整个执行过程有3次接口调用；同样，也会先发送第一次调用请求，接下来不同的是，tsf会保存此时执行的上下文，然后让出cpu给系统进行其他任务的处理；当接口响应时，再切回到之前保存的上下文继续执行。可以看出，和上面不同的是，tsf发送网络请求后，会让出cpu，而不是让cpu无所事事地等待响应，实现了网络调用的异步请求。可以进行更多地任务处理，大幅地提高了服务处理的QPS

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;上面的钓鱼例子中，此时相当于按照你想的的来做了，下好钩，然后看书，等鱼上钩……忽略鱼儿上钩后收鱼的时间，两个小时的时间内，一共钓到了12条鱼，同时也看了2个小时的书，效率是不是一下子就上去了呢！

## 执行流程的分析

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tsf可以配置对应的服务与端口，然后监听
